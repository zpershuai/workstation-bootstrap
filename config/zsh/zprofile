# Login shell config (primary settings).

# If this file is sourced from a non-login shell, skip expensive login init.
[[ -o login ]] || return 0

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
# Load local secrets if present.
if [[ -f "${HOME}/.config/secrets/env" ]]; then
  source "${HOME}/.config/secrets/env"
fi

# Homebrew shell env (Apple Silicon default path).
if [[ -x "/opt/homebrew/bin/brew" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# autojump (Homebrew install)
if [[ -f "/opt/homebrew/etc/profile.d/autojump.sh" ]]; then
  source "/opt/homebrew/etc/profile.d/autojump.sh"
fi

# dotfiles bin
export PATH="${HOME}/.dotfiles/bin:${PATH}"

# auto delete old files on login shells
auto_delete_bin="${HOME}/.dotfiles/bin/auto_delete.sh"
if [[ -x "${auto_delete_bin}" ]]; then
  "${auto_delete_bin}" --quiet
fi

# tmux: auto-attach when using SSH
if [[ -z "${TMUX:-}" && -n "${SSH_CONNECTION:-}" ]]; then
  "${HOME}/.dotfiles/bin/tmwork"
fi

# aliases
alias cat="bat"
alias tmatt="tmux att -t"
alias tmls="tmux ls"
alias tmnew="tmux new-session -s"
alias tmkill="tmux kill-session -t"
alias vim="nvim"
alias ls="${HOME}/.dotfiles/bin/ls"

mkdir_date() {
  local script="${HOME}/.dotfiles/bin/mkdir_date"
  if [[ -r "${script}" ]]; then
    source "${script}"
  else
    local data_dir="${HOME}/Log/$(date "+%Y_%m_%d")"
    mkdir -p "${data_dir}" || return 1
    cd "${data_dir}" || return 1
  fi
}

export VISUAL="nvim"
export EDITOR="nvim"
export LESSCHARSET="utf-8"

alias git='LANG=en_GB git'
# Add user-local bin paths.
export PATH="${HOME}/.local/bin:${PATH}"

# OpenJDK PATH
export PATH="/opt/homebrew/opt/openjdk/bin:${PATH}"

# mtl-cli 激活
if [[ -f "${HOME}/.mtl-cli/bin/mtl-activate" ]]; then
  source "${HOME}/.mtl-cli/bin/mtl-activate"
fi

# NVM: lazy load on first use to reduce shell startup time.
export NVM_DIR="${HOME}/.nvm"
_lazy_load_nvm() {
  unset -f nvm node npm npx corepack yarn pnpm _lazy_load_nvm
  if [[ -s "${NVM_DIR}/nvm.sh" ]]; then
    source "${NVM_DIR}/nvm.sh"
  fi
  if [[ -s "${NVM_DIR}/bash_completion" ]]; then
    source "${NVM_DIR}/bash_completion"
  fi
}
for __nvm_cmd in nvm node npm npx corepack yarn pnpm; do
  eval "${__nvm_cmd}() { _lazy_load_nvm; ${__nvm_cmd} \"\$@\"; }"
done
unset __nvm_cmd

# bun completions
if [[ -s "${HOME}/.bun/_bun" ]]; then
  source "${HOME}/.bun/_bun"
fi

# bun
export BUN_INSTALL="${HOME}/.bun"
export PATH="${BUN_INSTALL}/bin:${PATH}"

# Local env bootstrap if present.
if [[ -f "${HOME}/.local/bin/env" ]]; then
  . "${HOME}/.local/bin/env"
fi

alias claude-mem='${HOME}/.bun/bin/bun "${HOME}/.claude/plugins/marketplaces/thedotmack/plugin/scripts/worker-service.cjs"'
